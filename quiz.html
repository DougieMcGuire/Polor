<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Details - Polor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #52C4F5;
            --primary-blue-dark: #3BA8D1;
            --success-green: #51CF66;
            --error-red: #FF6B6B;
            --warning-orange: #FF922B;
            --purple-accent: #9775FA;
            --white: #FFFFFF;
            --black: #000000;
            --gray-100: #F8F9FA;
            --gray-200: #E9ECEF;
            --gray-300: #DEE2E6;
            --gray-600: #6C757D;
            --gray-700: #495057;
            --gray-800: #343A40;
            --font-primary: 'Fredoka', sans-serif;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--primary-blue) 0%, #87CEEB 100%);
            min-height: 100vh;
            color: var(--black);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .back-btn {
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            font-family: var(--font-primary);
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: var(--gray-100);
        }

        .quiz-header {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--gray-300);
        }

        .quiz-banner {
            display: flex;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .quiz-thumbnail {
            width: 300px;
            height: 180px;
            border-radius: var(--radius-xl);
            object-fit: cover;
            border: 3px solid var(--gray-300);
        }

        .quiz-info {
            flex: 1;
        }

        .quiz-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: var(--spacing-md);
        }

        .quiz-meta {
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-lg);
            font-size: 1rem;
            color: var(--gray-600);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .quiz-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            font-family: var(--font-primary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-host {
            background: var(--success-green);
            color: var(--white);
            border-color: var(--success-green);
            font-size: 1.1rem;
            padding: var(--spacing-lg) var(--spacing-xl);
        }

        .btn-host:hover {
            background: #45a555;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-purple {
            background: var(--purple-accent);
            color: var(--white);
            border-color: var(--purple-accent);
        }

        .btn-purple:hover {
            background: #845ef7;
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
            border-color: var(--error-red);
        }

        .btn-danger:hover {
            background: #e55a5a;
        }

        .questions-section {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--gray-300);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: var(--spacing-lg);
        }

        .question-card {
            background: var(--gray-100);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all 0.3s ease;
        }

        .question-card:hover {
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .question-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-blue);
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: var(--spacing-md);
        }

        .answers-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-sm);
        }

        .answer-item {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .answer-item.correct {
            border-color: var(--success-green);
            background: #e8f5e9;
            font-weight: 600;
        }

        .answer-item.correct::before {
            content: "✓";
            color: var(--success-green);
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-300);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 10001;
            max-width: 400px;
        }

        .notification {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary-blue);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-success {
            border-left-color: var(--success-green);
        }

        .notification-error {
            border-left-color: var(--error-red);
        }

        @media (max-width: 768px) {
            .quiz-banner {
                flex-direction: column;
            }

            .quiz-thumbnail {
                width: 100%;
            }

            .quiz-actions {
                flex-direction: column;
            }

            .quiz-actions .btn {
                width: 100%;
            }

            .answers-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="window.location.href='dashboard.html'">
            ← Back to Dashboard
        </button>

        <div class="quiz-header">
            <div class="quiz-banner">
                <img id="quiz-thumbnail" class="quiz-thumbnail" src="" alt="Quiz Thumbnail">
                <div class="quiz-info">
                    <h1 class="quiz-title" id="quiz-title">Loading...</h1>
                    <div class="quiz-meta">
                        <div class="meta-item">
                            <span>📝</span>
                            <span id="question-count">0 questions</span>
                        </div>
                        <div class="meta-item">
                            <span>🎯</span>
                            <span id="age-level">All ages</span>
                        </div>
                        <div class="meta-item">
                            <span>🕒</span>
                            <span id="created-date">Just now</span>
                        </div>
                        <div class="meta-item" id="difficulty-meta" style="display: none;">
                            <span>⭐</span>
                            <span id="difficulty">Medium</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="quiz-actions">
                <button class="btn btn-host" id="host-btn">
                    🎮 Host Game
                </button>
                <button class="btn btn-primary" id="edit-btn">
                    ✏️ Edit Quiz
                </button>
                <button class="btn btn-purple" id="share-btn">
                    📤 Share
                </button>
                <button class="btn btn-secondary" id="duplicate-btn">
                    📋 Duplicate
                </button>
                <button class="btn btn-danger" id="delete-btn">
                    🗑️ Delete
                </button>
            </div>
        </div>

        <div class="questions-section">
            <h2 class="section-title">Questions Preview</h2>
            <div id="questions-container">
                <!-- Questions will be loaded here -->
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loading-text">Loading quiz...</p>
        </div>
    </div>

    <div id="notification-container" class="notification-container"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyBYcuke7uz4kAQzMjUpEqbY6zvwOiY9C1k",
                authDomain: "polorapi.firebaseapp.com",
                databaseURL: "https://polorapi-default-rtdb.firebaseio.com",
                projectId: "polorapi",
                storageBucket: "polorapi.firebasestorage.app",
                messagingSenderId: "945305666819",
                appId: "1:945305666819:web:a3c535e6cb9273882a1536",
                measurementId: "G-PQ0J44YZTN"
            }
        };

        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let currentQuiz = null;
        let quizId = null;
        let ownerId = null;

        const LoadingManager = {
            show: function(text = 'Loading...') {
                document.getElementById('loading-text').textContent = text;
                document.getElementById('loading-overlay').classList.add('active');
            },
            hide: function() {
                document.getElementById('loading-overlay').classList.remove('active');
            }
        };

        const NotificationManager = {
            show: function(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                container.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            quizId = urlParams.get('quiz');

            if (!quizId) {
                NotificationManager.show('No quiz specified', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadQuiz();
                } else {
                    // Not logged in - might be viewing a shared quiz
                    loadSharedQuiz();
                }
            });

            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('host-btn').addEventListener('click', hostGame);
            document.getElementById('edit-btn').addEventListener('click', editQuiz);
            document.getElementById('share-btn').addEventListener('click', shareQuiz);
            document.getElementById('duplicate-btn').addEventListener('click', duplicateQuiz);
            document.getElementById('delete-btn').addEventListener('click', deleteQuiz);
        }

        async function loadQuiz() {
            LoadingManager.show('Loading quiz...');

            try {
                // Try to load from current user's quizzes
                const snapshot = await database.ref(`users/${currentUser.uid}/quizSets/${quizId}`).once('value');
                
                if (snapshot.exists()) {
                    currentQuiz = snapshot.val();
                    ownerId = currentUser.uid;
                    displayQuiz();
                } else {
                    // Check if it's a shared quiz or from another user
                    loadSharedQuiz();
                }
            } catch (error) {
                console.error('Error loading quiz:', error);
                LoadingManager.hide();
                NotificationManager.show('Failed to load quiz', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
            }
        }

        async function loadSharedQuiz() {
            // TODO: Implement shared quiz loading
            LoadingManager.hide();
            NotificationManager.show('Quiz not found', 'error');
            setTimeout(() => window.location.href = 'dashboard.html', 2000);
        }

        function displayQuiz() {
            LoadingManager.hide();

            if (!currentQuiz) return;

            // Set title and thumbnail
            document.getElementById('quiz-title').textContent = currentQuiz.title || 'Untitled Quiz';
            
            const thumbnail = currentQuiz.thumbnail || `https://image.pollinations.ai/prompt/${encodeURIComponent((currentQuiz.title || 'quiz') + ' education')}/width=600/height=360/nologo=true`;
            document.getElementById('quiz-thumbnail').src = thumbnail;

            // Set metadata
            const questionCount = currentQuiz.questions?.length || 0;
            document.getElementById('question-count').textContent = `${questionCount} question${questionCount !== 1 ? 's' : ''}`;
            document.getElementById('age-level').textContent = currentQuiz.ageLevel || 'All ages';
            
            if (currentQuiz.difficulty) {
                document.getElementById('difficulty-meta').style.display = 'flex';
                document.getElementById('difficulty').textContent = currentQuiz.difficulty.charAt(0).toUpperCase() + currentQuiz.difficulty.slice(1);
            }

            const createdDate = currentQuiz.createdAt ? new Date(currentQuiz.createdAt) : new Date();
            document.getElementById('created-date').textContent = getTimeAgo(createdDate);

            // Display questions
            displayQuestions();

            // Show/hide action buttons based on ownership
            const isOwner = currentUser && ownerId === currentUser.uid;
            document.getElementById('edit-btn').style.display = isOwner ? 'inline-flex' : 'none';
            document.getElementById('duplicate-btn').style.display = isOwner ? 'inline-flex' : 'none';
            document.getElementById('delete-btn').style.display = isOwner ? 'inline-flex' : 'none';
        }

        function displayQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            if (!currentQuiz.questions || currentQuiz.questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-600);">No questions in this quiz.</p>';
                return;
            }

            currentQuiz.questions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';

                const answersHtml = question.answers.map((answer, ansIndex) => 
                    `<div class="answer-item ${ansIndex === question.correct ? 'correct' : ''}">
                        ${answer}
                    </div>`
                ).join('');

                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Question ${index + 1}</span>
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="answers-list">
                        ${answersHtml}
                    </div>
                `;

                container.appendChild(questionCard);
            });
        }

        function hostGame() {
            if (!quizId) return;
            window.location.href = `host.html?quiz=${quizId}`;
        }

        function editQuiz() {
            if (!quizId) return;
            window.location.href = `quiz-creator.html?edit=${quizId}`;
        }

        async function shareQuiz() {
            if (!currentQuiz) return;

            try {
                LoadingManager.show('Creating share link...');

                const shareData = {
                    title: currentQuiz.title || 'Untitled Quiz',
                    quizData: currentQuiz,
                    sharedBy: currentUser.uid,
                    sharedAt: Date.now()
                };

                const shareRef = database.ref('sharedQuizzes').push();
                await shareRef.set(shareData);

                const shareUrl = `${window.location.origin}/quiz.html?quiz=${quizId}&share=${shareRef.key}`;

                LoadingManager.hide();

                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(shareUrl);
                    NotificationManager.show('Share link copied to clipboard!', 'success');
                } else {
                    prompt('Share this link:', shareUrl);
                }
            } catch (error) {
                console.error('Error sharing quiz:', error);
                LoadingManager.hide();
                NotificationManager.show('Failed to create share link', 'error');
            }
        }

        async function duplicateQuiz() {
            if (!currentQuiz || !currentUser) return;

            try {
                LoadingManager.show('Duplicating quiz...');

                const duplicatedQuiz = {
                    ...currentQuiz,
                    title: `${currentQuiz.title} (Copy)`,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                const newQuizRef = database.ref(`users/${currentUser.uid}/quizSets`).push();
                await newQuizRef.set(duplicatedQuiz);

                LoadingManager.hide();
                NotificationManager.show('Quiz duplicated successfully!', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
            } catch (error) {
                console.error('Error duplicating quiz:', error);
                LoadingManager.hide();
                NotificationManager.show('Failed to duplicate quiz', 'error');
            }
        }

        async function deleteQuiz() {
            if (!currentQuiz || !currentUser) return;

            if (!confirm(`Are you sure you want to delete "${currentQuiz.title || 'Untitled Quiz'}"? This action cannot be undone.`)) {
                return;
            }

            try {
                LoadingManager.show('Deleting quiz...');

                await database.ref(`users/${currentUser.uid}/quizSets/${quizId}`).remove();

                LoadingManager.hide();
                NotificationManager.show('Quiz deleted successfully!', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
            } catch (error) {
                console.error('Error deleting quiz:', error);
                LoadingManager.hide();
                NotificationManager.show('Failed to delete quiz', 'error');
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>