<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polor Avatar Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .iframe-editor {
            width: 100%;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        .iframe-header {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
        }
        
        .iframe-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 10px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .iframe-avatar svg {
            width: 100%;
            height: 100%;
        }
        
        .iframe-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .iframe-color-section {
            margin-bottom: 20px;
        }
        
        .iframe-color-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        
        .iframe-color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .iframe-color-option {
            width: 100%;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .iframe-color-option:hover {
            transform: scale(1.05);
            border-color: #666;
        }
        
        .iframe-color-option.selected {
            border-color: #333;
            border-width: 3px;
        }
        
        .iframe-category-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .iframe-category-tab {
            padding: 8px 4px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-size: 11px;
            font-weight: 600;
        }
        
        .iframe-category-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .iframe-items-section {
            min-height: 200px;
        }
        
        .iframe-items-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .iframe-item {
            width: 100%;
            height: 50px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: white;
        }
        
        .iframe-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .iframe-item.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .iframe-none {
            background: #f0f0f0;
            color: #999;
            font-size: 9px;
            text-align: center;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="app-content">
        <div class="loading">
            <h3>‚è≥ Loading...</h3>
            <p>Fetching avatar customization options</p>
        </div>
    </div>

    <script>
        let manifest = {};
        let avatarState = {
            selectedParts: {
                backgrounds: '', bases: 'base.png', hair: '1.png', eyes: 'BasicMale.png', 
                brows: 'Basic.png', mouths: 'Basic.png', noses: 'basic.png', neck: '',
                tops: '113.png', glasses: '', hats: ''
            },
            colors: {
                backgrounds: '#FFFFFF', bases: '#F4C2A1', hair: '#8B4513', eyes: '#000000',
                brows: '#654321', mouths: '#000000', noses: '#FFA07A', neck: '#000000',
                tops: '#FF0000', glasses: '#000000', hats: '#000000'
            }
        };

        const colorPalette = [
            '#FDBCB4', '#F4C2A1', '#E8B982', '#D1A374', '#C19A6B', '#A67C5A', '#8D5524', '#6B4423',
            '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#C9BAFF', '#FFBAF3', '#FFC9BA',
            '#FF9A9E', '#FECFEF', '#FECDA3', '#96E6A1', '#89CDF1', '#A8DADC', '#F1C0E8', '#CFBAF0',
            '#FF7F7F', '#FFD1A9', '#FFFACD', '#98FB98', '#87CEEB', '#DDA0DD', '#FFB6C1', '#F0E68C',
            '#FFA07A', '#FFDAB9', '#F5DEB3', '#90EE90', '#B0E0E6', '#D8BFD8', '#FFC0CB', '#F5F5DC'
        ];

        async function initialize() {
            try {
                const response = await fetch('https://polor.org/Avatars/manifest.json');
                manifest = await response.json();
                loadFromURL();
                buildInterface();
            } catch (error) {
                console.error('Load failed:', error);
                handleImageMode() || showError();
            }
        }

        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            Object.keys(avatarState.selectedParts).forEach(category => {
                const value = urlParams.get(category);
                if (value !== null) avatarState.selectedParts[category] = value;
            });
            Object.keys(avatarState.colors).forEach(category => {
                const value = urlParams.get(`${category}Color`);
                if (value) avatarState.colors[category] = `#${value}`;
            });
        }

        function handleImageMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('image') === 'true' || urlParams.get('I') === '1') {
                showImageOnly();
                return true;
            }
            return false;
        }

        async function showImageOnly() {
            const avatarSVG = renderAvatar();
            document.getElementById('app-content').innerHTML = `<div style="position: absolute; top: -9999px;">${avatarSVG}</div>`;
            
            setTimeout(async () => {
                const imageData = await convertToWebP();
                if (imageData) {
                    document.getElementById('app-content').innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: transparent; margin: 0; padding: 0;">
                            <img src="${imageData}" style="width: 200px; height: 200px; display: block;" alt="Avatar">
                        </div>`;
                    document.body.style.background = 'transparent';
                }
            }, 100);
        }

        function showError() {
            document.getElementById('app-content').innerHTML = `
                <div class="loading"><h3>‚ùå Loading Failed</h3><p>Could not fetch avatar assets</p></div>`;
        }

        function buildInterface() {
            const categories = ['hair', 'eyes', 'brows', 'mouths', 'noses', 'tops', 'glasses', 'hats'];
            
            document.getElementById('app-content').innerHTML = `
                <div class="iframe-editor">
                    <div class="iframe-header">
                        <div class="iframe-avatar" id="iframe-avatar-display">
                            ${renderAvatar()}
                        </div>
                    </div>
                    <div class="iframe-content">
                        <div class="iframe-color-section">
                            <div class="iframe-color-title">üé® Color</div>
                            <div class="iframe-color-grid" id="color-grid">
                                ${colorPalette.slice(0, 18).map(color => `
                                    <div class="iframe-color-option" 
                                         style="background-color: ${color}"
                                         data-color="${color}"
                                         onclick="updateColor('${color}')"></div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="iframe-category-tabs">
                            ${categories.map((category, index) => `
                                <div class="iframe-category-tab ${index === 0 ? 'active' : ''}" 
                                     onclick="switchCategory('${category}')">
                                    ${getIcon(category)}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="iframe-items-section">
                            ${categories.map((category, index) => `
                                <div class="iframe-items-grid ${index === 0 ? 'active' : ''}" 
                                     id="items-${category}" style="display: ${index === 0 ? 'grid' : 'none'}">
                                    ${buildItems(category)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
            
            // Set initial category
            window.currentCategory = 'hair';
            updateColorSelection();
        }

        function getIcon(category) {
            const icons = {
                hair: 'üíá', eyes: 'üëÅÔ∏è', brows: 'ü§®', mouths: 'üëÑ', 
                noses: 'üëÉ', tops: 'üëî', glasses: 'ü§ì', hats: 'üé©'
            };
            return icons[category] || 'üé®';
        }

        function buildItems(category) {
            const items = manifest[category] ? manifest[category].filter(item => !item.includes('overlay')) : [];
            const currentColor = avatarState.colors[category];
            
            return `
                <div class="iframe-item iframe-none ${avatarState.selectedParts[category] === '' ? 'selected' : ''}" 
                     onclick="selectItem('${category}', '')">None</div>
                ${items.slice(0, 15).map(item => `
                    <div class="iframe-item ${avatarState.selectedParts[category] === item ? 'selected' : ''}" 
                         onclick="selectItem('${category}', '${item}')">
                        ${generatePreview(category, item, currentColor)}
                    </div>
                `).join('')}
            `;
        }

        function generatePreview(category, item, color) {
            return `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <defs>
                        <filter id="filter_${category}_${item.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <feComponentTransfer in="SourceGraphic" result="greenMask">
                                <feFuncG type="discrete" tableValues="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1"/>
                            </feComponentTransfer>
                            <feFlood flood-color="${color}" result="replacementColor"/>
                            <feComposite in="replacementColor" in2="greenMask" operator="in" result="coloredGreens"/>
                            <feComposite in="SourceGraphic" in2="greenMask" operator="out" result="nonGreenAreas"/>
                            <feComposite in="nonGreenAreas" in2="coloredGreens" operator="over"/>
                        </filter>
                    </defs>
                    <image href="https://polor.org/Avatars/characters/${category}/${item}" 
                           x="0" y="0" width="40" height="40" 
                           filter="url(#filter_${category}_${item.replace(/[^a-zA-Z0-9]/g, '_')})"/>
                </svg>`;
        }

        function renderAvatar() {
            const { selectedParts, colors } = avatarState;
            const colorFilters = Object.entries(colors).map(([category, hexColor]) => `
                <filter id="greenFilter_${category}">
                    <feComponentTransfer in="SourceGraphic" result="greenMask">
                        <feFuncG type="discrete" tableValues="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1"/>
                    </feComponentTransfer>
                    <feFlood flood-color="${hexColor}" result="replacementColor"/>
                    <feComposite in="replacementColor" in2="greenMask" operator="in" result="coloredGreens"/>
                    <feComposite in="SourceGraphic" in2="greenMask" operator="out" result="nonGreenAreas"/>
                    <feComposite in="nonGreenAreas" in2="coloredGreens" operator="over"/>
                </filter>`).join('');

            const layerOrder = ['backgrounds', 'backgroundsoverlay', 'bases', 'basesoverlay', 'neck', 'neckoverlay', 
                               'hair', 'hairoverlay', 'eyes', 'eyesoverlay', 'brows', 'browsoverlay', 'noses', 'nosesoverlay',
                               'mouths', 'mouthsoverlay', 'tops', 'topsoverlay', 'glasses', 'glassesoverlay', 'hats', 'hatsoverlay'];
            
            const layers = [];
            layerOrder.forEach(layerName => {
                if (layerName.includes('overlay')) {
                    const baseCategory = layerName.replace('overlay', '');
                    const selectedItem = selectedParts[baseCategory];
                    if (selectedItem) {
                        const overlayFile = selectedItem.replace('.png', 'overlay.png');
                        layers.push(`<image href="https://polor.org/Avatars/characters/${baseCategory}/${overlayFile}" x="0" y="0" width="200" height="200"/>`);
                    }
                } else {
                    const selectedItem = selectedParts[layerName];
                    if (selectedItem) {
                        layers.push(`<image href="https://polor.org/Avatars/characters/${layerName}/${selectedItem}" x="0" y="0" width="200" height="200" filter="url(#greenFilter_${layerName})"/>`);
                    }
                }
            });

            return `
                <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>${colorFilters}</defs>
                    ${layers.join('')}
                </svg>`;
        }

        function switchCategory(category) {
            window.currentCategory = category;
            
            // Update tabs
            document.querySelectorAll('.iframe-category-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchCategory('${category}')"]`).classList.add('active');
            
            // Update items grid
            document.querySelectorAll('.iframe-items-grid').forEach(grid => {
                grid.style.display = 'none';
                grid.classList.remove('active');
            });
            const targetGrid = document.getElementById(`items-${category}`);
            if (targetGrid) {
                targetGrid.style.display = 'grid';
                targetGrid.classList.add('active');
            }
            
            // Update color selection
            updateColorSelection();
        }

        function selectItem(category, item) {
            avatarState.selectedParts[category] = item;
            updateDisplay();
            
            // Update selection in current category
            const currentGrid = document.getElementById(`items-${category}`);
            if (currentGrid) {
                currentGrid.querySelectorAll('.iframe-item').forEach(el => el.classList.remove('selected'));
                const targetItem = currentGrid.querySelector(`[onclick="selectItem('${category}', '${item}')"]`);
                if (targetItem) {
                    targetItem.classList.add('selected');
                }
            }
        }

        function updateColor(color) {
            const category = window.currentCategory || 'hair';
            avatarState.colors[category] = color;
            updateDisplay();
            updateColorSelection();
            
            // Update previews in current category
            const currentGrid = document.getElementById(`items-${category}`);
            if (currentGrid) {
                currentGrid.innerHTML = buildItems(category);
            }
        }

        function updateColorSelection() {
            const category = window.currentCategory || 'hair';
            const currentColor = avatarState.colors[category];
            
            document.querySelectorAll('.iframe-color-option').forEach(option => {
                option.classList.toggle('selected', option.getAttribute('data-color') === currentColor);
            });
        }

        function updateDisplay() {
            const avatarDisplay = document.getElementById('iframe-avatar-display');
            if (avatarDisplay) {
                avatarDisplay.innerHTML = renderAvatar();
            }
        }

        async function convertToWebP() {
            const { selectedParts, colors } = avatarState;
            
            return new Promise(async (resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                
                const layerOrder = [
                    'backgrounds', 'bases', 'neck', 'hair', 'eyes', 'brows', 
                    'noses', 'mouths', 'tops', 'glasses', 'hats'
                ];
                
                try {
                    for (const layerName of layerOrder) {
                        const selectedItem = selectedParts[layerName];
                        if (!selectedItem) continue;
                        
                        await drawLayerWithColor(ctx, layerName, selectedItem, colors[layerName]);
                        await drawOverlay(ctx, layerName, selectedItem);
                    }
                    
                    const webpData = canvas.toDataURL('image/webp', 0.9);
                    resolve(webpData);
                    
                } catch (error) {
                    console.error('Failed to bake avatar:', error);
                    resolve(null);
                }
            });
        }
        
        async function drawLayerWithColor(ctx, category, item, color) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = 200;
                    tempCanvas.height = 200;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCtx.drawImage(img, 0, 0, 200, 200);
                    
                    const imageData = tempCtx.getImageData(0, 0, 200, 200);
                    const data = imageData.data;
                    
                    const r = parseInt(color.slice(1,3), 16);
                    const g = parseInt(color.slice(3,5), 16);
                    const b = parseInt(color.slice(5,7), 16);
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const red = data[i];
                        const green = data[i + 1];
                        const blue = data[i + 2];
                        const alpha = data[i + 3];
                        
                        if (alpha < 200) continue;
                        
                        if (green > 200 && green > (red + 50) && green > (blue + 50)) {
                            const greenDominance = green - Math.max(red, blue);
                            if (greenDominance > 80) {
                                data[i] = r;
                                data[i + 1] = g;
                                data[i + 2] = b;
                            }
                        }
                    }
                    
                    tempCtx.putImageData(imageData, 0, 0);
                    ctx.drawImage(tempCanvas, 0, 0);
                    resolve();
                };
                
                img.onerror = () => {
                    console.log(`Failed to load ${category}/${item}, skipping...`);
                    resolve();
                };
                
                img.src = `https://polor.org/Avatars/characters/${category}/${item}`;
            });
        }
        
        async function drawOverlay(ctx, category, item) {
            return new Promise((resolve) => {
                const overlayFile = item.replace('.png', 'overlay.png');
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, 200, 200);
                    resolve();
                };
                
                img.onerror = () => {
                    resolve();
                };
                
                img.src = `https://polor.org/Avatars/characters/${category}/${overlayFile}`;
            });
        }

        // Load saved state and start
        const saved = localStorage.getItem('polor_avatar');
        if (saved) {
            try {
                avatarState = JSON.parse(saved);
            } catch (err) {}
        }
        
        initialize();
    </script>
</body>
</html>
